import React, { useState, useEffect } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Button,
  IconButton,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Chip,
  Alert,
  CircularProgress,
  Divider,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Grid,
  Paper,
  TextField,
  Pagination,
  Stack
} from '@mui/material';
import {
  Add as AddIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  TrendingUp as IncomeIcon,
  TrendingDown as ExpenseIcon,
  SwapHoriz as TransferIcon,
  FilterList as FilterIcon
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDateFns } from '@mui/x-date-pickers/AdapterDateFns';
import { zhTW } from 'date-fns/locale';
import { format } from 'date-fns';
import { AccountingRecord2, Account2, Category2 } from '@pharmacy-pos/shared/types/accounting2';
import { Organization } from '@pharmacy-pos/shared/types/organization';
import { accounting3Service } from '../../services/accounting3Service';
import organizationService from '../../services/organizationService';
import RecordForm from './RecordForm';

interface RecordListProps {
  selectedOrganizationId: string | null;
  refreshTrigger?: number;
}

interface RecordFilter {
  type?: 'income' | 'expense' | 'transfer';
  categoryId?: string;
  accountId?: string;
  startDate?: Date;
  endDate?: Date;
  page: number;
  limit: number;
}

const RecordList: React.FC<RecordListProps> = ({ selectedOrganizationId, refreshTrigger }) => {
  const [records, setRecords] = useState<AccountingRecord2[]>([]);
  const [accounts, setAccounts] = useState<Account2[]>([]);
  const [categories, setCategories] = useState<Category2[]>([]);
  const [organizations, setOrganizations] = useState<Organization[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [formOpen, setFormOpen] = useState(false);
  const [editingRecord, setEditingRecord] = useState<AccountingRecord2 | null>(null);
  const [pagination, setPagination] = useState({
    page: 1,
    limit: 20,
    total: 0,
    pages: 0
  });

  const [filter, setFilter] = useState<RecordFilter>({
    page: 1,
    limit: 20
  });

  // ËºâÂÖ•Ë®òÂ∏≥Ë®òÈåÑ
  const loadRecords = async () => {
    try {
      setLoading(true);
      setError(null);

      const params: any = {
        page: filter.page,
        limit: filter.limit
      };

      if (filter.type) params.type = filter.type;
      if (filter.categoryId) params.categoryId = filter.categoryId;
      if (filter.accountId) params.accountId = filter.accountId;
      if (filter.startDate) params.startDate = filter.startDate.toISOString();
      if (filter.endDate) params.endDate = filter.endDate.toISOString();
      if (selectedOrganizationId) params.organizationId = selectedOrganizationId;

      console.log('üîç RecordList ËºâÂÖ•Ë®òÈåÑ - ÂèÉÊï∏:', params);

      const response = await accounting3Service.records.getAll(params);
      if (response.success) {
        setRecords(response.data.records);
        setPagination(response.data.pagination);
        console.log('‚úÖ RecordList ËºâÂÖ•ÊàêÂäü:', response.data.records.length, 'Á≠ÜË®òÈåÑ');
      } else {
        setError('ËºâÂÖ•Ë®òÂ∏≥Ë®òÈåÑÂ§±Êïó');
      }
    } catch (err) {
      console.error('ËºâÂÖ•Ë®òÂ∏≥Ë®òÈåÑÈåØË™§:', err);
      setError('ËºâÂÖ•Ë®òÂ∏≥Ë®òÈåÑÊôÇÁôºÁîüÈåØË™§');
    } finally {
      setLoading(false);
    }
  };

  // ËºâÂÖ•Â∏≥Êà∂Ë≥áÊñô
  const loadAccounts = async () => {
    try {
      const response = await accounting3Service.accounts.getAll(selectedOrganizationId);
      if (response.success) {
        setAccounts(response.data);
        console.log('‚úÖ RecordList ËºâÂÖ•Â∏≥Êà∂ÊàêÂäü:', response.data.length, 'ÂÄãÂ∏≥Êà∂');
      }
    } catch (err) {
      console.error('ËºâÂÖ•Â∏≥Êà∂ÈåØË™§:', err);
    }
  };

  // ËºâÂÖ•È°ûÂà•Ë≥áÊñô
  const loadCategories = async () => {
    try {
      const params = selectedOrganizationId ? { organizationId: selectedOrganizationId } : {};
      const response = await accounting3Service.categories.getAll(params);
      if (response.success) {
        setCategories(response.data);
        console.log('‚úÖ RecordList ËºâÂÖ•È°ûÂà•ÊàêÂäü:', response.data.length, 'ÂÄãÈ°ûÂà•');
      }
    } catch (err) {
      console.error('ËºâÂÖ•È°ûÂà•ÈåØË™§:', err);
    }
  };

  // ËºâÂÖ•Ê©üÊßãË≥áÊñô
  const loadOrganizations = async () => {
    try {
      const response = await organizationService.getOrganizations();
      if (response.success) {
        setOrganizations(response.data);
        console.log('‚úÖ RecordList ËºâÂÖ•Ê©üÊßãÊàêÂäü:', response.data.length, 'ÂÄãÊ©üÊßã');
      }
    } catch (err) {
      console.error('ËºâÂÖ•Ê©üÊßãÈåØË™§:', err);
    }
  };

  useEffect(() => {
    loadRecords();
  }, [selectedOrganizationId, filter, refreshTrigger]);

  useEffect(() => {
    loadAccounts();
    loadCategories();
    loadOrganizations();
  }, [selectedOrganizationId, refreshTrigger]);

  // ËôïÁêÜË°®ÂñÆÊèê‰∫§
  const handleFormSubmit = async (recordData: Partial<AccountingRecord2>) => {
    try {
      setError(null);

      console.log('üì§ RecordList Êèê‰∫§Ë®òÈåÑË≥áÊñô:', recordData);

      let response;
      if (editingRecord) {
        // Êõ¥Êñ∞Ë®òÈåÑ
        response = await accounting3Service.records.update(editingRecord._id, recordData as any);
      } else {
        // Âª∫Á´ãÊñ∞Ë®òÈåÑ
        response = await accounting3Service.records.create(recordData as any);
      }

      if (response.success) {
        console.log('‚úÖ Ë®òÈåÑÊìç‰ΩúÊàêÂäü');
        setFormOpen(false);
        setEditingRecord(null);
        await loadRecords(); // ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
        await loadAccounts(); // ÈáçÊñ∞ËºâÂÖ•Â∏≥Êà∂È§òÈ°ç
      } else {
        setError(response.message || 'Êìç‰ΩúÂ§±Êïó');
      }
    } catch (err) {
      console.error('Ë®òÈåÑÊìç‰ΩúÈåØË™§:', err);
      setError('Êìç‰ΩúÊôÇÁôºÁîüÈåØË™§');
    }
  };

  // ËôïÁêÜÁ∑®ËºØ
  const handleEdit = (record: AccountingRecord2) => {
    console.log('üîç RecordList Á∑®ËºØË®òÈåÑ:', record);
    setEditingRecord(record);
    setFormOpen(true);
  };

  // ËôïÁêÜÂà™Èô§
  const handleDelete = async (recordId: string) => {
    if (!window.confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë®òÂ∏≥Ë®òÈåÑÂóéÔºü')) {
      return;
    }

    try {
      setError(null);
      const response = await accounting3Service.records.delete(recordId);
      
      if (response.success) {
        console.log('‚úÖ Ë®òÈåÑÂà™Èô§ÊàêÂäü');
        await loadRecords(); // ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
        await loadAccounts(); // ÈáçÊñ∞ËºâÂÖ•Â∏≥Êà∂È§òÈ°ç
      } else {
        setError(response.message || 'Âà™Èô§Â§±Êïó');
      }
    } catch (err) {
      console.error('Âà™Èô§Ë®òÈåÑÈåØË™§:', err);
      setError('Âà™Èô§ÊôÇÁôºÁîüÈåØË™§');
    }
  };

  // ÈóúÈñâË°®ÂñÆ
  const handleFormClose = () => {
    setFormOpen(false);
    setEditingRecord(null);
  };

  // ËôïÁêÜÁØ©ÈÅ∏ËÆäÊõ¥
  const handleFilterChange = (field: keyof RecordFilter, value: any) => {
    setFilter(prev => ({
      ...prev,
      [field]: value,
      page: 1 // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ†Å
    }));
  };

  // ËôïÁêÜÂàÜÈ†ÅËÆäÊõ¥
  const handlePageChange = (event: React.ChangeEvent<unknown>, value: number) => {
    setFilter(prev => ({
      ...prev,
      page: value
    }));
  };

  // Ê∏ÖÈô§ÁØ©ÈÅ∏
  const handleClearFilter = () => {
    setFilter({
      page: 1,
      limit: 20
    });
  };

  // ÂèñÂæóË®òÈåÑÈ°ûÂûãÂúñÁ§∫
  const getTypeIcon = (type: string) => {
    switch (type) {
      case 'income':
        return <IncomeIcon color="success" />;
      case 'expense':
        return <ExpenseIcon color="error" />;
      case 'transfer':
        return <TransferIcon color="info" />;
      default:
        return null;
    }
  };

  // ÂèñÂæóË®òÈåÑÈ°ûÂûãÊ®ôÁ±§
  const getTypeLabel = (type: string) => {
    switch (type) {
      case 'income':
        return 'Êî∂ÂÖ•';
      case 'expense':
        return 'ÊîØÂá∫';
      case 'transfer':
        return 'ËΩâÂ∏≥';
      default:
        return type;
    }
  };

  // ÂèñÂæóÈ°ûÂà•ÂêçÁ®±
  const getCategoryName = (categoryId: string) => {
    const category = categories.find(cat => cat._id === categoryId);
    return category ? category.name : 'Êú™Áü•È°ûÂà•';
  };

  // ÂèñÂæóÂ∏≥Êà∂ÂêçÁ®±
  const getAccountName = (accountId: string) => {
    const account = accounts.find(acc => acc._id === accountId);
    return account ? account.name : 'Êú™Áü•Â∏≥Êà∂';
  };

  // Ê∏≤ÊüìË®òÈåÑÈ†ÖÁõÆ
  const renderRecordItem = (record: AccountingRecord2) => (
    <ListItem key={record._id} divider>
      <ListItemText
        primary={
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            {getTypeIcon(record.type)}
            <Typography variant="body1" fontWeight="medium">
              {record.description || getCategoryName(record.categoryId as string)}
            </Typography>
            <Chip 
              label={getTypeLabel(record.type)} 
              size="small" 
              color={record.type === 'income' ? 'success' : record.type === 'expense' ? 'error' : 'info'}
            />
          </Box>
        }
        secondary={
          <Box>
            <Typography variant="body2" color="text.secondary">
              È°ûÂà•Ôºö{getCategoryName(record.categoryId as string)} | 
              Â∏≥Êà∂Ôºö{getAccountName(record.accountId as string)}
            </Typography>
            <Typography variant="caption" color="text.secondary">
              {format(new Date(record.date), 'yyyy/MM/dd HH:mm', { locale: zhTW })}
            </Typography>
            {record.tags && record.tags.length > 0 && (
              <Box sx={{ mt: 1 }}>
                {record.tags.map((tag, index) => (
                  <Chip
                    key={index}
                    label={tag}
                    size="small"
                    variant="outlined"
                    sx={{ mr: 0.5 }}
                  />
                ))}
              </Box>
            )}
          </Box>
        }
      />
      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mr: 2 }}>
        <Typography 
          variant="h6" 
          color={record.type === 'income' ? 'success.main' : 'error.main'}
          fontWeight="bold"
        >
          {record.type === 'income' ? '+' : '-'}${record.amount.toLocaleString()}
        </Typography>
      </Box>
      <ListItemSecondaryAction>
        <IconButton
          edge="end"
          aria-label="Á∑®ËºØ"
          onClick={() => handleEdit(record)}
          size="small"
        >
          <EditIcon />
        </IconButton>
        <IconButton
          edge="end"
          aria-label="Âà™Èô§"
          onClick={() => handleDelete(record._id)}
          size="small"
          color="error"
        >
          <DeleteIcon />
        </IconButton>
      </ListItemSecondaryAction>
    </ListItem>
  );

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
        <CircularProgress />
      </Box>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDateFns} adapterLocale={zhTW}>
      <Box>
        {/* Ê®ôÈ°åÂíåÊìç‰ΩúÂçÄ */}
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 3 }}>
          <Typography variant="h5" component="h2">
            Ë®òÂ∏≥Ë®òÈåÑ
          </Typography>
          <Button
            variant="contained"
            startIcon={<AddIcon />}
            onClick={() => setFormOpen(true)}
          >
            Êñ∞Â¢ûË®òÈåÑ
          </Button>
        </Box>

        {/* ÁØ©ÈÅ∏Âô® */}
        <Paper sx={{ p: 2, mb: 3 }}>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 2 }}>
            <FilterIcon />
            <Typography variant="h6">ÁØ©ÈÅ∏Ê¢ù‰ª∂</Typography>
            <Button size="small" onClick={handleClearFilter}>
              Ê∏ÖÈô§ÁØ©ÈÅ∏
            </Button>
          </Box>
          
          <Grid container spacing={2}>
            <Grid item xs={12} sm={6} md={3}>
              <FormControl fullWidth size="small">
                <InputLabel>Ë®òÈåÑÈ°ûÂûã</InputLabel>
                <Select
                  value={filter.type || ''}
                  onChange={(e) => handleFilterChange('type', e.target.value || undefined)}
                  label="Ë®òÈåÑÈ°ûÂûã"
                >
                  <MenuItem value="">ÂÖ®ÈÉ®</MenuItem>
                  <MenuItem value="income">Êî∂ÂÖ•</MenuItem>
                  <MenuItem value="expense">ÊîØÂá∫</MenuItem>
                  <MenuItem value="transfer">ËΩâÂ∏≥</MenuItem>
                </Select>
              </FormControl>
            </Grid>

            <Grid item xs={12} sm={6} md={3}>
              <FormControl fullWidth size="small">
                <InputLabel>È°ûÂà•</InputLabel>
                <Select
                  value={filter.categoryId || ''}
                  onChange={(e) => handleFilterChange('categoryId', e.target.value || undefined)}
                  label="È°ûÂà•"
                >
                  <MenuItem value="">ÂÖ®ÈÉ®</MenuItem>
                  {categories.map((category) => (
                    <MenuItem key={category._id} value={category._id}>
                      {category.icon} {category.name}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>

            <Grid item xs={12} sm={6} md={3}>
              <FormControl fullWidth size="small">
                <InputLabel>Â∏≥Êà∂</InputLabel>
                <Select
                  value={filter.accountId || ''}
                  onChange={(e) => handleFilterChange('accountId', e.target.value || undefined)}
                  label="Â∏≥Êà∂"
                >
                  <MenuItem value="">ÂÖ®ÈÉ®</MenuItem>
                  {accounts.map((account) => (
                    <MenuItem key={account._id} value={account._id}>
                      {account.name}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>

            <Grid item xs={12} sm={6} md={3}>
              <DatePicker
                label="ÈñãÂßãÊó•Êúü"
                value={filter.startDate || null}
                onChange={(newValue) => handleFilterChange('startDate', newValue)}
                renderInput={(params) => (
                  <TextField
                    {...params}
                    size="small"
                    fullWidth
                  />
                )}
              />
            </Grid>

            <Grid item xs={12} sm={6} md={3}>
              <DatePicker
                label="ÁµêÊùüÊó•Êúü"
                value={filter.endDate || null}
                onChange={(newValue) => handleFilterChange('endDate', newValue)}
                renderInput={(params) => (
                  <TextField
                    {...params}
                    size="small"
                    fullWidth
                  />
                )}
              />
            </Grid>
          </Grid>
        </Paper>

        {/* ÈåØË™§Ë®äÊÅØ */}
        {error && (
          <Alert severity="error" sx={{ mb: 2 }}>
            {error}
          </Alert>
        )}

        {/* Ë®òÈåÑÂàóË°® */}
        <Paper elevation={2}>
          <Box sx={{ p: 2, bgcolor: 'primary.light', color: 'primary.contrastText' }}>
            <Typography variant="h6">
              Ë®òÂ∏≥Ë®òÈåÑÂàóË°® ({pagination.total} Á≠Ü)
            </Typography>
          </Box>
          
          <List>
            {records.length > 0 ? (
              records.map(renderRecordItem)
            ) : (
              <ListItem>
                <ListItemText 
                  primary="Â∞öÁÑ°Ë®òÂ∏≥Ë®òÈåÑ" 
                  secondary="ÈªûÊìä‰∏äÊñπ„ÄåÊñ∞Â¢ûË®òÈåÑ„ÄçÊåâÈàïÂª∫Á´ãÁ¨¨‰∏ÄÁ≠ÜË®òÈåÑ"
                />
              </ListItem>
            )}
          </List>

          {/* ÂàÜÈ†Å */}
          {pagination.pages > 1 && (
            <Box sx={{ display: 'flex', justifyContent: 'center', p: 2 }}>
              <Stack spacing={2}>
                <Pagination
                  count={pagination.pages}
                  page={pagination.page}
                  onChange={handlePageChange}
                  color="primary"
                  showFirstButton
                  showLastButton
                />
                <Typography variant="caption" textAlign="center">
                  Á¨¨ {pagination.page} È†ÅÔºåÂÖ± {pagination.pages} È†Å | 
                  È°ØÁ§∫ {records.length} Á≠ÜÔºåÂÖ± {pagination.total} Á≠ÜË®òÈåÑ
                </Typography>
              </Stack>
            </Box>
          )}
        </Paper>

        {/* Ë®òÈåÑË°®ÂñÆÂ∞çË©±Ê°Ü */}
        <RecordForm
          open={formOpen}
          onClose={handleFormClose}
          onSubmit={handleFormSubmit}
          record={editingRecord}
          organizations={organizations}
          selectedOrganizationId={selectedOrganizationId}
          accounts={accounts}
          categories={categories}
        />
      </Box>
    </LocalizationProvider>
  );
};

export default RecordList;