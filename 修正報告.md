# 修正 fifo.js 的 NoSQL 注入防護

## 修正摘要

根據 nosql_injection_prevention_rules.md 的防護規範，我對 fifo.js 檔案進行了以下修正：

1. 將所有 `findById` 方法替換為 `findOne` 搭配查詢物件
2. 對所有查詢參數進行型態轉換 (toString())
3. 在比較操作中也進行參數型態轉換
4. 確保所有查詢參數都使用查詢物件包裝

## 具體修改點

1. `/sale/:saleId` 路由：
   - 將 `Sale.findById(req.params.saleId)` 替換為 `Sale.findOne({ _id: req.params.saleId.toString() })`
   - 在比較 `p.orderId === req.params.saleId` 時加入 `.toString()` 轉換

2. `/shipping-order/:shippingOrderId` 路由：
   - 將 `ShippingOrder.findById(req.params.shippingOrderId)` 替換為 `ShippingOrder.findOne({ _id: req.params.shippingOrderId.toString() })`
   - 在比較 `p.orderId === req.params.shippingOrderId` 時加入 `.toString()` 轉換

3. `/simulate` 路由：
   - 對 `productId` 參數進行型態轉換：`product: productId.toString()`
   - 在 `simulatedStockOut` 物件中對 `drug_id` 進行型態轉換：`drug_id: productId.toString()`
   - 在回傳結果中對 `productId` 進行型態轉換：`productId: productId.toString()`

## 測試計劃

為確保修改後的程式碼功能正常且安全，應進行以下測試：

1. 測試 `/product/:productId` 路由，確認能正確查詢產品 FIFO 資訊
2. 測試 `/sale/:saleId` 路由，確認能正確查詢銷售訂單的 FIFO 利潤
3. 測試 `/shipping-order/:shippingOrderId` 路由，確認能正確查詢出貨單的 FIFO 利潤
4. 測試 `/all` 路由，確認能正確查詢所有產品的 FIFO 資訊
5. 測試 `/simulate` 路由，確認能正確模擬產品的 FIFO 成本

所有測試應包含正常輸入和異常輸入（如非法 ID 格式）的情況，確保系統能正確處理並防禦 NoSQL 注入攻擊。
