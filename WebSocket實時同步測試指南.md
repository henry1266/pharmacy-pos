# WebSocket 實時同步測試指南

## 🎯 測試目標
確認當任何一台電腦在 sales/new2 頁面提交銷售記錄時，所有其他連接的電腦都能即時看到畫面刷新。

## 📋 測試前準備

### 1. 主機設定 (192.168.68.90)

**啟動後端服務：**
```bash
cd d:/pharmacy-pos
pnpm run dev
```

**啟動前端服務（允許外部訪問）：**
```bash
# 使用提供的腳本
啟動前端-允許外部訪問.bat
```

**確認防火牆設定：**
```bash
# 允許 3000 埠號（前端）
netsh advfirewall firewall add rule name="Pharmacy POS Frontend" dir=in action=allow protocol=TCP localport=3000

# 允許 5000 埠號（後端）
netsh advfirewall firewall add rule name="Pharmacy POS Backend" dir=in action=allow protocol=TCP localport=5000
```

### 2. 其他電腦設定

**⚠️ 重要：其他電腦不需要運行任何程式！**

直接在瀏覽器中訪問主機的前端應用：
- 銷售頁面：`http://192.168.68.90:3000/sales/new2`
- WebSocket 測試頁面：`http://192.168.68.90:3000/websocket-test`

## 🧪 測試步驟

### 步驟 1：基礎連接測試

1. **主機測試**：
   - 訪問 `http://localhost:3000/websocket-test`
   - 確認連接狀態顯示「已連接」
   - 點擊「加入房間」
   - 點擊「測試銷售事件」，確認能收到事件

2. **其他電腦測試**：
   - 訪問 `http://192.168.68.90:3000/websocket-test`
   - 確認連接狀態顯示「已連接」
   - 點擊「加入房間」

### 步驟 2：實時同步測試

1. **準備階段**：
   - 主機：打開 `http://localhost:3000/sales/new2`
   - 其他電腦：打開 `http://192.168.68.90:3000/sales/new2`
   - 確認所有電腦都能看到相同的銷售清單

2. **測試銷售記錄建立**：
   - 在主機上建立一筆銷售記錄
   - 觀察其他電腦是否自動刷新並顯示新記錄
   - 在其他電腦上建立一筆銷售記錄
   - 觀察主機是否自動刷新並顯示新記錄

3. **測試銷售記錄編輯**：
   - 在任一台電腦上編輯銷售記錄
   - 觀察其他電腦是否自動刷新並顯示更新

## 🔍 故障排除

### 問題 1：WebSocket 無法連接

**檢查項目：**
- 後端服務是否正常運行（檢查 5000 埠號）
- 前端服務是否以 HOST=0.0.0.0 啟動
- 防火牆是否允許 3000 和 5000 埠號
- 網路連通性（ping 192.168.68.90）

**解決方案：**
```bash
# 檢查埠號是否被佔用
netstat -an | findstr :5000
netstat -an | findstr :3000

# 重新啟動服務
# 1. 停止所有相關程序
# 2. 使用 啟動前端-允許外部訪問.bat 重新啟動前端
# 3. 重新啟動後端
```

### 問題 2：連接成功但無法接收事件

**檢查項目：**
- 瀏覽器開發者工具 Console 是否有錯誤
- WebSocket 是否成功加入 sales-new2 房間
- 後端是否正確發送事件

**調試方法：**
1. 打開瀏覽器開發者工具 (F12)
2. 查看 Console 標籤頁的日誌
3. 查看 Network 標籤頁的 WebSocket 連接

### 問題 3：部分電腦無法接收事件

**可能原因：**
- 網路延遲或不穩定
- 瀏覽器快取問題
- WebSocket 連接中斷

**解決方案：**
1. 重新整理頁面 (F5)
2. 清除瀏覽器快取
3. 檢查網路連接穩定性
4. 重新訪問頁面

## 📊 預期結果

### 正常運作時應該看到：

1. **WebSocket 測試頁面**：
   - 連接狀態：已連接 ✅
   - 能成功加入房間 ✅
   - 測試事件能正常收發 ✅

2. **銷售頁面**：
   - 任一台建立銷售記錄時，其他台立即顯示通知 ✅
   - 銷售清單自動刷新 ✅
   - 所有電腦顯示相同的最新資料 ✅

3. **瀏覽器 Console 日誌**：
   ```
   ✅ WebSocket 已連接: [socket-id]
   🏠 已加入 sales-new2 房間
   📥 收到銷售記錄建立事件: {message: "新的銷售記錄已建立"}
   ```

## 🚨 常見錯誤訊息

### 錯誤 1：連接被拒絕
```
❌ WebSocket 連接錯誤: Error: connect ECONNREFUSED
```
**解決方案：** 檢查後端服務是否運行，確認 5000 埠號可訪問

### 錯誤 2：CORS 錯誤
```
❌ Access to XMLHttpRequest blocked by CORS policy
```
**解決方案：** 確認後端 CORS 設定正確，允許前端域名訪問

### 錯誤 3：房間加入失敗
```
⚠️ 無法加入房間：WebSocket 未連接
```
**解決方案：** 等待 WebSocket 連接建立後再嘗試加入房間

## 📞 技術支援

如果按照以上步驟仍無法解決問題，請提供以下資訊：

1. 瀏覽器開發者工具的 Console 錯誤訊息
2. Network 標籤頁中的 WebSocket 連接狀態
3. 主機和其他電腦的 IP 位址
4. 防火牆和網路設定資訊

## 🎉 成功標準

測試成功的標準：
- ✅ 所有電腦都能連接到 WebSocket
- ✅ 所有電腦都能成功加入 sales-new2 房間
- ✅ 任一台建立銷售記錄時，其他台能即時收到通知
- ✅ 銷售清單在所有電腦上同步更新
- ✅ 無明顯延遲或錯誤