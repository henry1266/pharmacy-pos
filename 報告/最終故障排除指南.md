# WebSocket 實時同步最終故障排除指南

## 🚨 當前狀況
- 主機 IP: 192.168.68.90
- 主機可以正常刷新
- 其他電腦無法同步刷新

## 📋 完整檢查清單

### 步驟 1: 確認後端伺服器狀態
```bash
# 在主機 (192.168.68.90) 上執行
cd d:/pharmacy-pos
pnpm run dev
```

**檢查點：**
- [ ] 伺服器啟動成功
- [ ] 看到 "伺服器已啟動，監聽埠號: 5000" 訊息
- [ ] 沒有 CORS 或 Socket.IO 錯誤

### 步驟 2: 確認網路連通性
在其他電腦上執行：
```bash
ping 192.168.68.90
```

**檢查點：**
- [ ] 能收到回應 (Reply from 192.168.68.90)
- [ ] 延遲時間合理 (< 100ms)

### 步驟 3: 測試 API 連接
在其他電腦的瀏覽器中訪問：
```
http://192.168.68.90:5000/api/sales
```

**檢查點：**
- [ ] 能看到 JSON 資料
- [ ] 沒有連接超時或拒絕錯誤

### 步驟 4: 檢查防火牆設定
在主機上執行：
```bash
# 檢查防火牆狀態
netsh advfirewall show allprofiles state

# 允許 5000 埠號
netsh advfirewall firewall add rule name="Pharmacy POS Server" dir=in action=allow protocol=TCP localport=5000
```

### 步驟 5: 設定環境變數
在每台其他電腦上創建 `frontend/.env.local`：
```env
REACT_APP_API_URL=http://192.168.68.90:5000
REACT_APP_SERVER_URL=http://192.168.68.90:5000
```

### 步驟 6: 重新啟動前端應用
在每台電腦上：
```bash
# 停止前端 (Ctrl+C)
cd d:/pharmacy-pos/frontend
pnpm start
```

### 步驟 7: 使用調試工具
1. 開啟 `WebSocket調試工具.html`
2. 確認伺服器 URL 為 `http://192.168.68.90:5000`
3. 點擊「連接」
4. 點擊「加入房間」
5. 點擊「測試銷售事件」

**檢查點：**
- [ ] 連接狀態顯示「已連接」
- [ ] 能成功加入房間
- [ ] 測試事件能正常發送和接收

### 步驟 8: 測試 WebSocket 測試頁面
在每台電腦上訪問：
```
http://localhost:3000/websocket-test
```

**檢查點：**
- [ ] 連接狀態顯示「已連接」
- [ ] 能成功「加入房間」
- [ ] 點擊「測試銷售事件」能收到訊息

### 步驟 9: 最終實時同步測試
1. 在主機開啟 `http://localhost:3000/sales/new2`
2. 在其他電腦開啟 `http://localhost:3000/sales/new2`
3. 在任一台電腦提交銷售記錄
4. 觀察其他電腦是否自動刷新

## 🔧 常見問題解決

### 問題 1: WebSocket 連接失敗
**症狀：** 調試工具顯示「連接失敗」

**解決方案：**
1. 確認主機 IP 正確
2. 確認後端伺服器運行
3. 檢查防火牆設定
4. 嘗試暫時關閉防火牆測試

### 問題 2: API 可以連接但 WebSocket 無法連接
**症狀：** 能訪問 API 但 WebSocket 測試失敗

**解決方案：**
1. 檢查 Socket.IO 版本兼容性
2. 確認後端 CORS 設定正確
3. 嘗試使用 polling 傳輸模式

### 問題 3: 連接成功但無法加入房間
**症狀：** 顯示已連接但加入房間失敗

**解決方案：**
1. 檢查後端房間處理邏輯
2. 確認事件名稱正確 (`join-sales-new2`)
3. 增加連接延遲時間

### 問題 4: 能加入房間但收不到事件
**症狀：** 房間加入成功但測試事件無回應

**解決方案：**
1. 檢查後端事件廣播邏輯
2. 確認事件名稱匹配 (`sale-created`, `sale-updated`)
3. 檢查前端事件監聽器註冊

### 問題 5: 環境變數不生效
**症狀：** 設定了 .env.local 但仍連接 localhost

**解決方案：**
1. 確認檔案名稱正確 (`.env.local` 不是 `.env.local.txt`)
2. 確認檔案位置在 `frontend/` 目錄下
3. 重新啟動前端應用
4. 檢查瀏覽器開發者工具的 Network 標籤

## 🛠️ 快速修復工具

### 使用一鍵修復腳本
```bash
cd d:/pharmacy-pos
一鍵修復WebSocket.bat
```

### 使用診斷腳本
```bash
cd d:/pharmacy-pos
診斷-192.168.68.90.bat
```

## 📊 成功標準

當以下所有條件都滿足時，實時同步應該正常工作：

1. ✅ 主機後端伺服器運行正常
2. ✅ 其他電腦能 ping 通主機
3. ✅ 其他電腦能訪問主機的 API
4. ✅ WebSocket 調試工具顯示「已連接」
5. ✅ WebSocket 測試頁面顯示「已連接」
6. ✅ 能成功加入 sales-new2 房間
7. ✅ 測試事件能正常發送和接收
8. ✅ 在任一台電腦提交銷售記錄時，其他電腦自動刷新

## 🆘 如果仍然無法解決

### 收集診斷資訊

1. **主機狀態**
   - 後端伺服器控制台輸出
   - 防火牆設定截圖

2. **其他電腦狀態**
   - WebSocket 調試工具截圖
   - 瀏覽器開發者工具 Console 錯誤
   - 瀏覽器開發者工具 Network 標籤

3. **網路環境**
   - 路由器型號和設定
   - 是否使用 VPN 或代理

### 替代解決方案

如果 WebSocket 實時同步仍然無法正常工作，可以考慮：

1. **手動刷新按鈕**
   - 在 sales/new2 頁面添加「刷新」按鈕
   - 用戶可以手動點擊刷新清單

2. **定時自動刷新**
   - 設定每 30 秒自動刷新一次
   - 在沒有 WebSocket 連接時啟用

3. **輪詢機制**
   - 使用 HTTP 輪詢替代 WebSocket
   - 每 10 秒檢查一次新的銷售記錄

---

**重要提醒：**
- 每次修改設定後都要重新啟動相關服務
- 確保所有電腦都在同一區域網路中
- 如果使用 Wi-Fi，確保信號穩定