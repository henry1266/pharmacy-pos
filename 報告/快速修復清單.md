# WebSocket 實時同步快速修復清單

## 🚨 立即執行步驟

### 1. 重新啟動後端伺服器 (必須！)
```bash
# 在主機上停止現有伺服器 (Ctrl+C)
# 然後重新啟動
cd d:/pharmacy-pos
pnpm run dev
```
**原因：** 剛修改了 CORS 設定，必須重啟才能生效

### 2. 執行快速設置腳本
```bash
# 在主機上執行
setup-websocket.bat
```
這會自動：
- 獲取您的 IP 位址
- 創建正確的 `.env.local` 檔案

### 3. 在其他電腦上設定 IP
將步驟 2 顯示的 IP 位址複製到其他電腦的 `frontend/.env.local`：
```env
REACT_APP_API_URL=http://[您的IP]:5000
REACT_APP_SERVER_URL=http://[您的IP]:5000
```

### 4. 重新啟動所有前端應用
在每台電腦上：
```bash
# 停止前端 (Ctrl+C)
cd d:/pharmacy-pos/frontend
pnpm start
```

### 5. 測試連接
在每台電腦上訪問：
```
http://localhost:3000/websocket-test
```

檢查是否顯示「已連接」狀態

## 🔍 快速診斷

### 如果 WebSocket 測試頁面顯示「未連接」：

1. **檢查 IP 設定**
   - 確認 `.env.local` 中的 IP 正確
   - 確認後端伺服器在該 IP 上運行

2. **檢查網路連通性**
   ```bash
   # 在其他電腦上測試
   ping [主機IP]
   ```

3. **檢查防火牆**
   - 暫時關閉主機的 Windows 防火牆
   - 或允許 Node.js 通過防火牆

### 如果連接成功但不會自動刷新：

1. **確認房間加入**
   - WebSocket 測試頁面應顯示「已加入房間」

2. **測試事件廣播**
   - 在測試頁面點擊「測試銷售事件」
   - 其他電腦應該收到訊息

## ✅ 成功標準

當以下條件都滿足時，實時同步就會正常工作：

1. ✅ 主機後端伺服器運行在正確 IP
2. ✅ 所有電腦的 WebSocket 測試頁面顯示「已連接」
3. ✅ 所有電腦都能成功「加入房間」
4. ✅ 在任一台電腦提交銷售記錄時，其他電腦的 sales/new2 頁面自動刷新

## 🆘 如果仍然無法解決

請提供以下資訊：

1. 主機 IP 位址：`_____________`
2. WebSocket 測試頁面連接狀態：`_____________`
3. 瀏覽器控制台錯誤訊息：`_____________`
4. 是否在同一區域網路：`_____________`

## 📞 常見錯誤對照

| 錯誤訊息 | 解決方案 |
|---------|---------|
| `ECONNREFUSED` | 檢查 IP 位址和後端伺服器狀態 |
| `CORS policy` | 確認後端已重新啟動 |
| `未連接` | 檢查 `.env.local` 設定 |
| `無法加入房間` | 等待連接建立或手動加入 |

---

**記住：最重要的是重新啟動後端伺服器！**