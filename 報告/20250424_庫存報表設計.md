# 庫存報表重新設計方案

## 1. 需求分析

根據用戶需求，需要重新設計庫存報表，主要功能包括：

1. 添加更豐富的篩選功能：
   - 供應商篩選
   - 類別篩選
   - 商品編號/名稱篩選

2. 盈虧計算功能：
   - 對列出的貨物的所有inventories記錄進行盈虧計算
   - 按照貨單單號做成圖表
   - 使用@mui/x-charts/LineChart來實現圖表顯示

## 2. 系統現狀分析

### 2.1 前端實現

現有的庫存報表實現在`ReportsPage.js`中，主要功能包括：

- 從`/api/reports/inventory`獲取庫存數據
- 顯示庫存總值、潛在收入等摘要信息
- 支持按類別篩選
- 顯示按類別和產品類型分組的統計信息

### 2.2 後端實現

後端API實現在`reports.js`和`inventory.js`中：

- `/api/reports/inventory`：提供庫存報表數據，支持按產品類型篩選
- `/api/inventory`：提供庫存基本操作
- `/api/inventory/product/:productId`：獲取特定產品的庫存記錄

### 2.3 數據結構

庫存數據主要包括：

- 產品信息：ID、編號、名稱、類別、類型等
- 庫存信息：數量、進貨價、售價、庫存價值等
- 進貨單信息：進貨單ID、進貨單號等

## 3. 設計方案

### 3.1 前端設計

#### 3.1.1 UI設計

新的庫存報表頁面將包含以下部分：

1. **篩選區域**：
   - 供應商下拉選擇器
   - 類別下拉選擇器
   - 商品編號/名稱搜索框
   - 篩選按鈕

2. **摘要卡片**：
   - 總庫存價值
   - 潛在收入
   - 潛在利潤
   - 低庫存商品數量

3. **庫存列表**：
   - 顯示符合篩選條件的庫存項目
   - 包含商品編號、名稱、類別、供應商、數量、單位、進貨價、售價等信息

4. **盈虧圖表**：
   - 使用@mui/x-charts/LineChart顯示按貨單單號的盈虧計算結果
   - X軸為貨單單號
   - Y軸為盈虧金額
   - 可切換不同的圖表視圖（折線圖、柱狀圖等）

#### 3.1.2 組件結構

```
components/
└── reports/
    └── inventory/
        ├── InventoryReport.js         # 主組件
        ├── InventoryFilters.js        # 篩選器組件
        ├── InventorySummary.js        # 摘要卡片組件
        ├── InventoryTable.js          # 庫存列表表格組件
        └── InventoryProfitLossChart.js # 盈虧圖表組件
```

### 3.2 後端設計

#### 3.2.1 API設計

修改現有的`/api/reports/inventory`API，添加新的篩選參數：

```
GET /api/reports/inventory
參數：
- supplier: 供應商ID（可選）
- category: 類別（可選）
- productCode: 商品編號（可選）
- productName: 商品名稱（可選）
- productType: 產品類型（可選，'product'或'medicine'）
```

添加新的API用於獲取盈虧計算數據：

```
GET /api/reports/inventory/profit-loss
參數：
- supplier: 供應商ID（可選）
- category: 類別（可選）
- productCode: 商品編號（可選）
- productName: 商品名稱（可選）
- productType: 產品類型（可選，'product'或'medicine'）
```

#### 3.2.2 數據處理邏輯

1. **篩選邏輯**：
   - 根據提供的篩選參數過濾庫存數據
   - 支持部分匹配和精確匹配

2. **盈虧計算邏輯**：
   - 獲取符合篩選條件的產品的所有庫存記錄
   - 按照貨單單號分組
   - 計算每個貨單的盈虧情況（售價 - 進貨價）* 數量
   - 返回按貨單單號排序的盈虧數據

### 3.3 數據流設計

1. 用戶選擇篩選條件並點擊篩選按鈕
2. 前端發送請求到後端API
3. 後端處理請求，過濾數據並計算盈虧
4. 前端接收數據並更新UI顯示
5. 用戶可以查看庫存列表和盈虧圖表

## 4. 技術實現要點

### 4.1 前端實現要點

1. **篩選器實現**：
   - 使用Material-UI的Select、Autocomplete和TextField組件
   - 實現動態加載供應商和類別數據
   - 實現商品編號/名稱的模糊搜索

2. **圖表實現**：
   - 使用@mui/x-charts/LineChart實現折線圖
   - 支持圖表縮放和數據點交互
   - 支持切換不同的圖表視圖

### 4.2 後端實現要點

1. **查詢優化**：
   - 使用索引優化查詢性能
   - 實現分頁加載大量數據

2. **數據聚合**：
   - 使用MongoDB的聚合管道進行數據處理
   - 實現複雜的分組和計算邏輯

## 5. 實現計劃

1. 修改後端API，添加新的篩選參數和盈虧計算邏輯
2. 創建新的前端組件，實現UI界面
3. 實現篩選功能和數據加載邏輯
4. 實現盈虧計算和圖表顯示
5. 測試和優化
6. 部署和上線

## 6. 預期效果

新的庫存報表將提供更豐富的篩選功能和數據可視化能力，幫助用戶更好地了解庫存情況和盈虧分析。用戶可以根據供應商、類別、商品編號/名稱等條件篩選庫存數據，並通過圖表直觀地查看盈虧情況。
